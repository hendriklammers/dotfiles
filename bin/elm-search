#!/bin/bash
#
# Interactively searching Elm packages using fzf and jq

# exit when any command fails
set -e

jsonFile="/tmp/elm_search.json"

if curl -s --fail https://package.elm-lang.org/search.json -o $jsonFile; then
  preview="jq '.[] | select(.name == \"{}\")' $jsonFile"
  $(jq  -r -M '.[] | .name' $jsonFile \
  | fzf --preview "$preview" --bind 'ctrl-o:execute(open https://package.elm-lang.org/packages/{}/latest/),ctrl-i:execute(elm install {})+abort' \
  | tr -d '\n' | pbcopy)
else
  echo "Unable to fetch package information from https://package.elm-lang.org"
fi
